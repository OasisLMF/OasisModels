<img src="https://oasislmf.org/packages/oasis_theme_package/themes/oasis_theme/assets/src/oasis-lmf-colour.png" alt="Oasis LMF logo" width="250"/>

# PiWind Pre-Analysis

The purpose of pre-analysis routines are to provide flexibility to manipulate the OED input files before the model is run, for augmentation as required by the model. The code and cofig are completely customisable; the user can change these to modify input files in any way they desire to achieve a particular output. The way that this feature has been used in this example model is by integrating an external geocoder.

This model amends OED location data that's missing Latitude and Longitude fields, which are needed for the model to 
yeild accurate results. It uses Precisely's Geocode API to assign the incomplete location addresses lat-long values based on the location data available (street address, postal code, country code, etc.).

To use Precisely's API, the model first needs to gain access via an access token. This is achieved by passing your API key and 
secret key with requests. To run the model, your keys need to be inserted in tests/test_x/exposure_pre_analysis_geocode.json.
More information of how to gain your keys can be found [here](https://docs.precisely.com/docs/sftw/precisely-apis/main/en-us/webhelp/apis/Getting%20Started/making_first_call.html).

The location data is then geocoded. The incomplete address data is extracted from the Loc file and passed to Precisely's 
Geocode API, along with the access token. The API returns a complete version of the addresses which included the lat-long pairs. 
These are inserted into the Loc file to complete it, along with new Geocode OED fields (if not already present). This complete data is then passed to the model to run.

The example loc file in this model contains 20 locations - the first 20 addresses of the original PiWind location file. Six of the addresses in this loc file have empty Latitude and Longitude fields (addresses 1, 4, 5, 14, 18, 19). Running this model will fill in these feilds with geocoding, before the analysis. Once the model is run, this can be checked by looking in the file at `runs/losses-<UTC timestamp>/input/location.csv`.

PLEASE NOTE: Precisely offer three levels of service that correspond to the precision of their Geocode API. This can be changed by altering the "Geocode_URI" key in exposure_pre_analysis_geocode.json. The default is set to 'Advanced' - Precisely's mid-range service. More information on their levels of service can be found [here](https://docs.precisely.com/docs/sftw/precisely-apis/main/en-us/webhelp/apis/Geocode/Geocode/LI_Geo_GET_url.html).

## Cloning the repository

You can clone this repository from <a href="https://github.com/OasisLMF/OasisModels" target="_blank">GitHub</a>.

## Compatibility

OasisLMF 1.27.0 and later

## Before running the model

Before running the model, you will need to insert you own API keys to utilise Precisely's geocoding for the pre analysis adjustments. The keys need to be inserted in <a href="https://github.com/OasisLMF/OasisModels/blob/feature/geocode/PiWindPreAnalysis/tests/test_1/exposure_pre_analysis.json" target="_blank">tests/test_x/exposure_pre_analysis.json</a>. Creating an account at <a href="https://www.precisely.com/" target="_blank">precisely.com</a> will generate your own set of keys for this.

## Running via the Oasis MDK

The <a href="https://pypi.org/project/oasislmf/" target="_blank">Oasis model development kit (MDK)</a> is a Python package which provides a command line interface (CLI) for developing and running models using the Oasis framework. It can be installed via the Python package installer `pip` (or `pip3` for Python 3). The PiWindPostcode model contains a <a href="https://github.com/OasisLMF/OasisModels/PiWindPostcode/blob/master/oasislmf.json" target="_blank">JSON configuration file</a> that allows the PiWind model to be run via the MDK.

A range of tests are available to run in the tests/ directory.

Within each test subdirectory, using the configuration file an end-to-end analysis can be executed using the command:

	oasislmf model run -C oasislmf.json

Files will be generated by default in a UTC timestamped folder named `runs/losses-<UTC timestamp`> in your working directory.

