<img src="https://oasislmf.org/packages/oasis_theme_package/themes/oasis_theme/assets/src/oasis-lmf-colour.png" alt="Oasis LMF logo" width="250"/>

# PiWind Postcode

Toy UK windstorm and flood model for exposures known at postcode resolution.

This model includes 'aggregate' footprints which are defined at postcode resolution and include hazard intensity probability distributions for some postcodes. This hazard intensity uncertainty is used as a proxy for location uncertainty for exposures which are only known at postcode level, in order to assign probabilities to the hazard intensity it will experience based on where it might be located.

The method of generating the aggregate footprint is detailed below, along with different features that can be used to handle spatial correlation, unknown vulnerability attributes and disaggregation of aggregate exposure data.

## Cloning the repository

You can clone this repository from <a href="https://github.com/OasisLMF/OasisModels" target="_blank">GitHub</a>.

## Running via the Oasis MDK

The <a href="https://pypi.org/project/oasislmf/" target="_blank">Oasis model development kit (MDK)</a> is a Python package which provides a command line interface (CLI) for developing and running models using the Oasis framework. It can be installed via the Python package installer `pip` (or `pip3` for Python 3). The PiWindPostcode model contains a <a href="https://github.com/OasisLMF/OasisModels/PiWindPostcode/blob/master/oasislmf.json" target="_blank">JSON configuration file</a> that allows the PiWind model to be run via the MDK.

A range of tests are available to run in the tests/ directory.

Within each test subdirectory, using the configuration file an end-to-end analysis can be executed using the command:

	oasislmf model run -C oasislmf.json

Files will be generated by default in a UTC timestamped folder named `runs/losses-<UTC timestamp`> in your working directory.

## Correlation feature

Model providers can specify detailed spatial correlation settings for both hazard (where the footprint has hazard intensity uncertainty), and damage. This is achieved by specifying peril correlation groups, spatial correlation groups and global correlation factors in the model settings file in meta_data/model_settings.json

Firstly, a multi-peril model such as this one requires a peril correlation grouping, which specifies whether peril damage for a given exposure should be fully correlated or independent. The two perils in this model are assigned two separate groups, 1 and 2, which means there is no correlation between the hazard or damage caused by each peril.

    "lookup_settings":{
        "supported_perils":[
           {"id": "WSS", "desc": "Single Peril: Storm Surge", "peril_correlation_group": 1},
           {"id": "WTC", "desc": "Single Peril: Tropical Cyclone", "peril_correlation_group": 2},
           ]

The data settings specify how spatial correlation groups are defined.  The model provider can use any OED fields, or internal Oasis fields such as areaperil_id to specify how to group items that will be fully correlated. 

In this example an individual risk, identified by PortNumber, AccNumber and LocNumber, is defined as a spatial correlation group, meaning that all its coverages will be fully correlated for both hazard and damage, per peril group. These grouping fields can be specified entirely differently for hazard and damage, if preferred.

    "data_settings": {
    "damage_group_fields": ["PortNumber", "AccNumber", "LocNumber"],
    "hazard_group_fields": ["PortNumber", "AccNumber", "LocNumber"]
    },   

For the ground up loss sampling, a independent set of random numbers is generated for each spatial group.

Optionally the model provider can specify correlation_settings, which are global correlation factors that are used to correlate the random numbers generated for each of the spatial groups. Again, these factors can be specified separately for hazard correlation and damage correlation.

    "correlation_settings": [
      {"peril_correlation_group":  1, "damage_correlation_value":  "0.7", "hazard_correlation_value":  "0.4"},
      {"peril_correlation_group":  2, "damage_correlation_value":  "0.5", "hazard_correlation_value":  "0.2"}
    ],

If no correlation_settings are specified, the default behaviour is that there will be zero correlation between the spatial groups.

In order to make use of this feature, the full Monte Carlo sampling approach (calculation component 'gulmc') must be used. This can be specified in the oasislmf.json file as follows;

```
    "modelpy": true,
    "gulmc": true,
    "gulpy": false
```

## Weighted vulnerability model feature

PiWind Postcode has 4 more vulnerability functions than PiWind, with ids 13-16 representing an unknown occupancy type for the 4 combinations of peril and coverage.

| vulnerability_id | peril    | coverage_type   | occupancy code   |
|:-----------------|----------|-----------------| ----------------:|
|       13         | WTC      |    1            | 1000             |
|       14         | WTC      |    3            | 1000             |
|       15         | WSS      |    1            | 1000             |
|       16         | WSS      |    3            | 1000             |


These are listed in the vulnerability dictionary.

When a location has OccupancyCode = 1000 (unknown), instead of it being matched with a default detailed vulnerability function, it is matched with one of the new aggregate vulnerability_ids and a weighted average of detailed vulnerability functions is computed dynamically depending on its areaperil.

The weightings have been derived from some information about the built environment, specifically a list of all known buildings with addresses and occupancy codes in the OED location file src/exposure_modification/OEDLocBuiltEnv.csv.

The process followed was;

1. Run the OED location file representing the built environment through the key server to get a list of vulnerability_ids for each location.

2. Group by areaperil_id and vulnerability_id and count the number of locations. This data is used to create the required weights file.

3. For any missing areaperil_ids from this list (ie grid cells with no buildings in the built environment data) a default vulnerability id was assigned with weight 1, to prevent errors from occurring. This list was appended to the weights file.

The weightings are represented in the model data as two extra files;

1) **aggregate_vulnerability** which contains the mapping from aggregate vulnerability ids 13-16 to detailed vulnerability ids 1-12 
2) **weights** which contain the weights of detailed vulnerability ids within each grid cell (areaperil_id). The numbers are integers representing the count of buildings from which relative weights can be derived.

There is no need to pre-generate vulnerability functions 13-16 because the weightings are applied on-the-fly during the analysis. Therefore the vulnerability file is the same as the one for the PiWind model.

An example test can be ran in tests/test_2.

## Aggregate footprint model feature

The model contains event footprints at postal code resolution (full 7 character postcode only) as well as grid cell resolution.

The PiWind footprint by grid cell (10 x 10) was generated with a single hazard intensity value by event and by cell, i.e. there is no hazard uncertainty. 

The PiWind Postcode footprint has been generated from the grid cell footprint with hazard intensity uncertainty using some information about the built environment, specifically, a list of all known buildings with addresses and occupancy codes in the OED location file src/exposure_modification/OEDLocBuiltEnv.csv.

The process followed was;

1. Run the OED location file representing the built environment through the key server to get a list of grid cell areaperils for each location.

2. For each postcode appearing in the OED location file, count the number of buildings assigned to each grid cell areaperil.

3. Create a new range of areaperils for the list of represented postcodes for each peril (201-724 for WTC and 725 to 1248 for WSS).

4. For each event footprint, create a new event footprint for the postcode areaperils by looking up the grid cell areaperils and intensity_bins for the postcode areaperil and using the building counts in step 2 as weights for the intensity_bin probability.

5. Append the postcode footprint to the grid cell footprint and sort by event_id, areaperil_id, intensity_bin_id.

An example test can be ran tests/test_3.


## Pre-analysis disaggregation feature

An example pre-analysis adjustment logic is available to demonstrate partial disaggregation for aggregate risks of unknown occupancy type.

This module splits aggregate location records (NumberOfBuildings>1) where OccupancyCode=1000 (unknown) into many rows and proportionally
allocates TIV and NumberOfBuildings to specific OccupancyCode's, where this data exists in the reference dataset (OEDLocBuildEnv) representing 
the built environment. OccupancyCodes are matched to locations on the PostalCode field, which is the required locator field for exposures.

This represents a partial disaggregation of aggregate locations to assign the attributes that are important in the model (just OccupancyCode for PiWindPostcode) and then the partially disaggregated risks will be split equally into individual buildings using the kernel disaggregation feature (see below).

This routine demonstrates how the model provider can augment the source location data with information that is important for the model (to make the best choice of vulnerability functions, given the exposure's location) using known built environment data in OED location format, without performing a full disaggregation to individual building level pre-analysis. 

An example test can be ran tests/test_4.

## Kernel disaggregation feature

In order to avoid large aggregate portfolios being fully disaggregated pre-analysis (which can produce very big location files and slow down file preparation runtime) Oasis has a feature which disaggregates locations with identical risk characteristics and multiple buildings into individual buildings in the kernel for the purposes of loss sampling.  This means that the aggregate risks are not treated as one (with perfectly correlated losses) and the risk profile of the portfolio is represented more realistically.  

Each aggregate risk is split into a number of risks based on the value of NumberOfBuildings (where it is >1) with TIV distributed equally to the subrisks for each coverage.  Location deductibles and limits are converted into % TIV values (Ded/LimitType = 2) and all subrisks are assigned the same % deductibles and/or limits.

An example test can be ran tests/test_5.